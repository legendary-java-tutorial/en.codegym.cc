Customizing the Query Cache
<p>----------------------------------------</p>
Why you need a query cache. Clearing the cache. Manual clearing of the cache.
<p>----------------------------------------</p>
<h2>Why you need a query cache</h2>
<p>Let's rewrite our example with getting employees in HQL:</p>
<pre class=" line-numbers language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span><code class=" language-java"><span class="token class-name">Employee</span> director1 <span class="token operator">=</span> session<span class="token punctuation">.</span><span class="token function">createQuery</span><span class="token punctuation">(</span><span class="token string">"from Employee where id = 4"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">uniqueResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">Employee</span> director2 <span class="token operator">=</span> session<span class="token punctuation">.</span><span class="token function">createQuery</span><span class="token punctuation">(</span><span class="token string">"from Employee where id = 4"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">uniqueResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">assertTrue</span><span class="token punctuation">(</span>director1 <span class="token operator">!=</span> director2<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p>The results of such queries <span class="text-red">are not stored</span> by either the first or second level cache.</p>
<p>This is exactly where <strong>the query cache</strong> can be used . It is also disabled by default. To enable it, add the following line to the configuration file:</p>
<pre><code>&lt;property name="hibernate.cache.use_query_cache" value="true"/&gt;</code></pre>
<p>But this is only half the solution. We have enabled the query cache, but we also need to specify which query results we want to cache. This must be written in the Query:</p>
<pre class=" line-numbers language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span><code class=" language-java"><span class="token class-name">Query</span> query <span class="token operator">=</span> session<span class="token punctuation">.</span><span class="token function">createQuery</span><span class="token punctuation">(</span><span class="token string">"from Employee where id = 4"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
query<span class="token punctuation">.</span><span class="token function">setCacheable</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">Employee</span> director1 <span class="token operator">=</span> query<span class="token punctuation">.</span><span class="token function">uniqueResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p>The query cache is similar to a second level cache. But, unlike it, here the key to the cache data is not the object identifier, but the set of query parameters. And the data itself is the identifiers of the objects that match the query criteria. Thus, it is rational to use this cache with the second level cache.</p>
<h2>Clearing the cache</h2>
<p>One of the important tasks when working with a cache is to make sure that cached objects change and remove them from the cache (or update them). Hibernate does this very well. Sometimes it even seems that he is guided by the rule “clear the cache in any incomprehensible situation.”</p>
<p>Let's say you want to update user data via HQL:</p>
<pre class=" line-numbers language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span><code class=" language-java"><span class="token class-name">Query</span> query <span class="token operator">=</span> session<span class="token punctuation">.</span><span class="token function">createQuery</span><span class="token punctuation">(</span><span class="token string">"update Employee set name=’Alex’ where id = 4"</span><span class="token punctuation">)</span>
query<span class="token punctuation">.</span> <span class="token function">executeUpdate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p>Hibernate cannot know exactly what has changed in the database, but it knows that you are changing an Employee object. Therefore, after executing this query, Hibernate will delete <strong>all objects</strong> of type Employee from its cache.</p>
<p>But NativeQuery works even more interesting:</p>
<pre class=" line-numbers language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span><code class=" language-java"><span class="token class-name">Query</span> nativeQuery <span class="token operator">=</span> session<span class="token punctuation">.</span><span class="token function">createNativeQuery</span><span class="token punctuation">(</span><span class="token string">"update employee set name=’Alex’ where id = 4"</span><span class="token punctuation">)</span>
nativeQuery<span class="token punctuation">.</span><span class="token function">executeUpdate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p>A native SQL query to the database has been executed. This means that something has changed in the database - the request was called in the <span class="code text-orange">executeUpdate()</span> method . Therefore, in this case, Hibernate will play it safe and remove <strong>all objects <span class="text-red">of all</span> types</strong> from its cache .</p>
<p>How do you like that? You call a harmless request, and Hibernate in response erases all the data from the cache! This is certainly better than if he kept objects that differ from the base, but that's it!</p>
<p>Therefore, the creators of Hibernate quickly figured out how to help Hibernate in this case. You can tell it which entity type to remove from the cache:</p>
<pre class=" line-numbers language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span><code class=" language-java"><span class="token class-name">Query</span> nativeQuery <span class="token operator">=</span> session<span class="token punctuation">.</span><span class="token function">createNativeQuery</span><span class="token punctuation">(</span><span class="token string">"update employee set name=’Alex’ where id = 4"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
nativeQuery<span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>hibernate<span class="token punctuation">.</span></span>SQLQuery</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addSynchronizedEntityClass</span><span class="token punctuation">(</span><span class="token class-name">Employee</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
nativeQuery<span class="token punctuation">.</span><span class="token function">executeUpdate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><strong>Remark</strong> . Native <strong>select</strong> queries <strong>don't flush the cache</strong> , only insert, update, delete, procedure calls, etc. 
<h2>Manual cache clearing</h2>
<p>For certain reasons, you may want to delete an object from the cache yourself. This can be done in different ways.</p>
<p><strong>Note</strong> . Objects in the cache are stored in groups called <strong>regions</strong> . By default, the region name is the same as the class name. Therefore, if you have objects of type <strong>com.codegym.Employee</strong> , then all of them will be stored in a group (region) with the name “ <strong>com.codegym.employee</strong> ”.</p>
<p>If you want to access the cache and do something with it, you can do it with the SessionFactory object and the <span class="code text-orange">getCache()</span> method :</p>
<pre class=" line-numbers language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span></span><code class=" language-java">session<span class="token punctuation">.</span><span class="token function">getSessionFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getCache</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">evictQueryRegion</span><span class="token punctuation">(</span>"com<span class="token punctuation">.</span>codegym<span class="token punctuation">.</span>employee”<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p>If you want to delete data from all groups (regions), then you need to run the following query:</p>
<pre class=" line-numbers language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span></span><code class=" language-java">session<span class="token punctuation">.</span><span class="token function">getSessionFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getCache</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">evictAllRegions</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p>To remove one object from the cache, you need to pass its name (type) and id. You can do this in two ways:</p>
<pre class=" line-numbers language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span><code class=" language-java">session<span class="token punctuation">.</span><span class="token function">getSessionFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getCache</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">evictEntityData</span><span class="token punctuation">(</span>"<span class="token class-name">Employee</span>”<span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

session<span class="token punctuation">.</span><span class="token function">getSessionFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getCache</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">evictEntityData</span><span class="token punctuation">(</span><span class="token class-name"><span class="token namespace">com<span class="token punctuation">.</span>codegym<span class="token punctuation">.</span></span>Employee</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p>You can also check if a particular object is in the cache:</p>
<pre class=" line-numbers language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span><code class=" language-java">session<span class="token punctuation">.</span><span class="token function">getSessionFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getCache</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">containsEntity</span><span class="token punctuation">(</span>"<span class="token class-name">Employee</span>”<span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
session<span class="token punctuation">.</span><span class="token function">getSessionFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getCache</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">containsEntity</span><span class="token punctuation">(</span><span class="token class-name"><span class="token namespace">com<span class="token punctuation">.</span>codegym<span class="token punctuation">.</span></span>Employee</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>