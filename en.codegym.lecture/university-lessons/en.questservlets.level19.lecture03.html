Concurrent Queues
<p>----------------------------------------</p>
Non-Blocking Queues Blocking Queues BlockingQueue&lt;E&gt; Implementations
<p>----------------------------------------</p>
<h2>Non-Blocking Queues</h2><img data-max-width="512" data-id="128e424c-63bb-47db-9d23-7ce3ae97fa4a" alt="" src="https://cdn.javarush.com/images/article/128e424c-63bb-47db-9d23-7ce3ae97fa4a/512.jpeg" style="width: 512px;">
<p>Thread-safe and most importantly non-blocking <span class="text-neon"><span class="text-bold"><em>Queue</em></span></span> implementations on linked nodes.</p>
<p><span class="code"><span class="text-green">ConcurrentLinkedQueue&lt;E&gt;</span></span> - it uses a wait-free algorithm adapted to work with the garbage collector. This algorithm is quite efficient and very fast, as it is built on CAS. <span class="code text-orange">The size()</span> methodcan run for a long time, so it's best not to pull it all the time.</p>
<p><span class="code"><span class="text-green">ConcurrentLinkedDeque&lt;E&gt;</span></span> - Deque stands for Double ended queue. This means that data can be added and pulled from both sides. Accordingly, the class supports both modes of operation: FIFO (First In First Out) and LIFO (Last In First Out).</p>
<p>In practice, <span class="code"><span class="text-green">ConcurrentLinkedDeque</span></span> should be used if LIFO is absolutely necessary, since due to the bidirectionality of the nodes, this class loses half in performance compared to <span class="code"><span class="text-green">ConcurrentLinkedQueue</span></span> .</p>
<pre class=" line-numbers language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><code class=" language-java"><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span></span><span class="token class-name">ConcurrentLinkedQueue</span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span>  <span class="token class-name">ConcurrentLinkedQueueExample</span> <span class="token punctuation">{</span>
   <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token class-name">ConcurrentLinkedQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> queue <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConcurrentLinkedQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

       <span class="token class-name">Thread</span> producer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Producer</span><span class="token punctuation">(</span>queue<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token class-name">Thread</span> consumer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Consumer</span><span class="token punctuation">(</span>queue<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

       producer<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       consumer<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">Producer</span> <span class="token keyword">implements</span> <span class="token class-name">Runnable</span> <span class="token punctuation">{</span>

   <span class="token class-name">ConcurrentLinkedQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> queue<span class="token punctuation">;</span>
   <span class="token class-name">Producer</span><span class="token punctuation">(</span><span class="token class-name">ConcurrentLinkedQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> queue<span class="token punctuation">)</span><span class="token punctuation">{</span>
       <span class="token keyword">this</span><span class="token punctuation">.</span>queue <span class="token operator">=</span> queue<span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Class for adding items to the queue"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token keyword">try</span> <span class="token punctuation">{</span>
           <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">5</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
               queue<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">"Item #"</span> <span class="token operator">+</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
               <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Added: Item #"</span> <span class="token operator">+</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
               <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">300</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
           <span class="token punctuation">}</span>
       <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
           ex<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
           <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">interrupt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token punctuation">}</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">Consumer</span> <span class="token keyword">implements</span> <span class="token class-name">Runnable</span> <span class="token punctuation">{</span>

   <span class="token class-name">ConcurrentLinkedQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> queue<span class="token punctuation">;</span>
   <span class="token class-name">Consumer</span><span class="token punctuation">(</span><span class="token class-name">ConcurrentLinkedQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> queue<span class="token punctuation">)</span><span class="token punctuation">{</span>
       <span class="token keyword">this</span><span class="token punctuation">.</span>queue <span class="token operator">=</span> queue<span class="token punctuation">;</span>
   <span class="token punctuation">}</span>

   <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token class-name">String</span> str<span class="token punctuation">;</span>
       <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Class for getting items from the queue"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> x <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> x <span class="token operator">&lt;</span> <span class="token number">5</span><span class="token punctuation">;</span> x<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
           <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>str <span class="token operator">=</span> queue<span class="token punctuation">.</span><span class="token function">poll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
               <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Pulled out: "</span> <span class="token operator">+</span> str<span class="token punctuation">)</span><span class="token punctuation">;</span>
           <span class="token punctuation">}</span>
           <span class="token keyword">try</span> <span class="token punctuation">{</span>
               <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">600</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
           <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
               ex<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
               <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">interrupt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
           <span class="token punctuation">}</span>
       <span class="token punctuation">}</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<h2>Blocking Queues</h2>
<img data-max-width="1080" data-id="8c8152d6-ffe6-4165-879c-3bcae893696f" src="https://cdn.codegym.cc/images/article/8c8152d6-ffe6-4165-879c-3bcae893696f/1080.jpeg" alt="">
<p><span class="text-neon"><span class="text-bold"><em>BlockingQueue&lt;E&gt;</em></span></span> interface - if there is a lot of data, <span class="code"><span class="text-green">ConcurrentLinkedQueue</span></span> is not enough.</p>
<p>When threads fail to do their job, you can easily get <span class="text-red"><span class="text-bold">an OutOfMemmoryException</span></span> . And so that such cases do not arise, we have <span class="text-neon"><span class="text-bold"><em>a BlockingQueue</em></span></span> for work with the presence of different methods for filling and working with the queue and conditional locks.</p>
<p><span class="text-neon"><span class="text-bold"><em>BlockingQueue</em></span></span> does not recognize null elements and throws<span class="text-red"><span class="text-bold"> a NullPointerException</span></span> when trying to add or get such an element. The poll method returns a null element if no element has been placed in the queue within the timeout.</p>
<h2>BlockingQueue&lt;E&gt; Implementations</h2>
<p>Let's take a closer look at each of our <span class="text-neon"><span class="text-bold"><em>BlockingQueue</em></span></span> implementations :</p>
<p><span class="code"><span class="text-green">ArrayBlockingQueue&lt;E&gt;</span></span> is a blocking queue class built on the classic ring buffer. Here we have the opportunity to manage the “honesty” of locks. If fair=false (the default), then thread ordering is not guaranteed.</p>
<p><span class="code"><span class="text-green">DelayQueue&lt;E extends Delayed&gt;</span></span> is a class that allows you to pull elements from the queue only after a certain delay, defined in each element through the<span class="code text-orange"> getDelay method of the </span><span class="text-neon"><span class="text-bold"><em>Delayed</em></span></span> interface.</p>
<p><span class="code"><span class="text-green">LinkedBlockingQueue&lt;E&gt;</span></span> is a blocking queue on linked nodes, implemented on the “two lock queue” algorithm: the first lock is for adding, the second is for pulling an element from the queue. Due to locks, compared to<span class="code"><span class="text-green"> ArrayBlockingQueue</span></span> , this class has high performance, but it requires more memory. The queue size is set via the constructor and is equal to Integer.MAX_VALUE by default.</p>
<p><span class="code"><span class="text-green">PriorityBlockingQueue&lt;E&gt;</span></span> is a multi-threaded wrapper over<span class="code"><span class="text-green"> PriorityQueue</span></span> . <span class="text-neon"><span class="text-bold"><em>The Comparator</em></span></span> is responsible for the logic by which the element will be added. The smallest element comes out first.</p>
<p><span class="code"><span class="text-green">SynchronousQueue&lt;E&gt;</span></span> - the queue works according to the FIFO (first-in-first-out) principle. Each insert operation blocks the “Producer” thread until the “Consumer” thread pulls the element from the queue and vice versa, the “Consumer” will wait until the “Producer” inserts the element.</p>
<p><span class="text-neon"><span class="text-bold"><em>BlockingDeque&lt;E&gt;</em></span></span> is an interface that describes additional methods for a bidirectional blocking queue. Data can be inserted and pulled out from both sides of the queue.</p>
<p><span class="code"><span class="text-green">LinkedBlockingDeque&lt;E&gt;</span></span> is a bidirectional blocking queue on linked nodes, implemented as a simple bidirectional list with one lock. The queue size is set via the constructor and is equal to Integer.MAX_VALUE by default.</p>
<p><span class="text-neon"><span class="text-bold"><em>TransferQueue&lt;E&gt;</em></span></span> - the interface is interesting in that when an element is added to the queue, it is possible to block the inserting<span class="text-green"><span class="text-bold"> Producer</span></span> thread until another<span class="text-green"><span class="text-bold"> Consumer</span></span> thread pulls the element from the queue. You can also add a check for a specific timeout or set a check for pending<span class="text-green"><span class="text-bold"> Consumer s</span></span> . As a result, we get a data transfer mechanism with support for asynchronous and synchronous messages.</p>
<p><span class="code"><span class="text-green">LinkedTransferQueue&lt;E&gt;</span></span> is an implementation<span class="text-neon"><span class="text-bold"><em> of TransferQueue</em></span></span> based on the Dual Queues with Slack algorithm. Makes heavy use of CAS (see above) and thread parking when idle.</p>