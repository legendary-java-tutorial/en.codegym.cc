Data caching in Hibernate
<p>----------------------------------------</p>
Never write your caching solution. Caching in the database. Types of caching in Hibernate. Second level caching.
<p>----------------------------------------</p>
>Another way to speed up the work with the database is to cache objects that we have already requested earlier.</p>
<p><strong>Important! </strong>Never write your own caching solution. This task has so many pitfalls that you never dreamed of.</p>
<p>Issue 1 - <strong>cache flush</strong> . Sometimes events occur when an object needs to be removed from the cache or updated in the cache. The only way to do this competently is to pass all requests to the database through the cache engine. Otherwise, each time you will have to explicitly tell the cache which objects in it should be deleted or updated.</p>
<p>Problem 2 - <strong>lack of memory</strong> . Caching seems like a great idea until you find that objects in memory take up a lot of space. You need additional tens of gigabytes of memory for the server application cache to work effectively.</p>
<p>And since there is always a shortage of memory, an effective strategy for deleting objects from the cache is needed. This is somewhat similar to the garbage collector in Java. And as you remember, for decades the best minds have been inventing various ways of marking objects by generations, etc.</p>
<p>Problem 3 - <strong>different strategies</strong> . As practice shows, different strategies for storing and updating in the cache are effective for different objects. An efficient caching system cannot do just one strategy for all objects.</p>
<p>Problem 4 - <strong>Efficient storage of</strong> . You can't just store objects in the cache. Objects too often contain references to other objects, and so on. At this rate, you won't need a garbage collector: it just won't have anything to remove.</p>
<p>Therefore, instead of storing the objects themselves, it is sometimes much more efficient to store the values ​​of their primitive fields. And systems for quickly constructing objects based on them.</p>
<p>As a result, you will get a whole virtual DBMS in memory, which should work quickly and consume little memory.</p>
<h2>Database caching</h2>
<p>In addition to caching directly in a Java program, caching is often organized directly in the database.</p>
<p>There are four big approaches:</p>
<p>The first approach is <strong>to denormalize the database</strong> . The SQL server stores data in memory differently from how it is stored in tables.</p>
<p>When data is stored on disk in tables, very often developers try to avoid data duplication as much as possible - this process is called database normalization. So, to speed up work with data in memory, the reverse process is performed - database denormalization. A bunch of related tables can already be stored in a combined form - in the form of huge tables, etc.</p>
<p>The second approach is <strong>query caching</strong> . And query results.</p>
<p>The DBMS sees that very often the same or similar requests come to it. Then it simply starts caching these requests and their responses. But at the same time, you need to make sure that rows that have changed in the database are removed from the cache in a timely manner.</p>
<p>This approach can be very effective with a human being who can analyze queries and help the DBMS figure out how best to cache them.</p>
<p>The third approach is <strong>an in-memory database</strong> .</p>
<p>Another commonly used approach. Another database is placed between the server and the DBMS, which stores all its data only in memory. It is also called In-Memory-DB. If you have many different servers accessing the same database, then using In-Memory-DB you can organize caching based on the type of a particular server.</p>
<p>Example:</p><img data-max-width="1024" data-id="9f2582a5-e5db-4280-88ff-6f605c256bdf" alt="" src="https://cdn.javarush.com/images/article/9f2582a5-e5db-4280-88ff-6f605c256bdf/1024.jpeg" style="width: 1024px;">
<p>Approach 4 - <strong>database cluster</strong> . Several read-only bases.</p>
<p>Another solution is to use a cluster: several DBMSs of the same type contain identical data. At the same time, you can read data from all databases, and write to only one. Which is then synchronized with the rest of the databases.</p>
<p>This is a very good solution because it is easy to configure and works in practice. Usually, for one request to the database to change data, 10-100 requests for reading data come to it.</p>
<h2>Types of caching in Hibernate</h2>
<p>Hibernate supports three levels of caching:</p>
<ul>
 <li>Caching at the session level (Session)</li>
 <li>Caching at the SessionFactory level</li>
 <li>Caching requests (and their results)</li>
</ul>
<p>You can try to represent this system in the form of such a figure:</p><img data-max-width="800" data-id="63696278-18d4-4dc4-ba87-fc9f4bc24c11" alt="" src="https://cdn.javarush.com/images/article/63696278-18d4-4dc4-ba87-fc9f4bc24c11/800.jpeg" style="width: 800px;">
<p>The simplest type of caching (also called <strong>the first level cache</strong> ) is implemented at the Hibernate session level. <span class="text-green">Hibernate always uses this cache by default</span> and <span class="text-red">cannot be disabled</span> .</p>
<p>Let's immediately consider the following example:</p>
<pre class=" line-numbers language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span><code class=" language-java"><span class="token class-name">Employee</span> director1 <span class="token operator">=</span> session<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token class-name">Employee</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">Employee</span> director2 <span class="token operator">=</span> session<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token class-name">Employee</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">assertTrue</span><span class="token punctuation">(</span>director1 <span class="token operator">==</span> director2<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p>It may seem that two queries to the database will be executed here, but this is not so. After the first request to the database, the Employee object will be cached. And if you query the object again in the same session, Hibernate will return the same Java object.</p>
<p>The same object means that even object references will be identical. It's really the same object.</p>
<p><span class="code text-orange">The save()</span> , <span class="code text-orange">update()</span> , <span class="code text-orange">saveOrUpdate()</span> , <span class="code text-orange">load()</span> , <span class="code text-orange">get()</span> , <span class="code text-orange">list()</span> , <span class="code text-orange">iterate() ,</span> and <span class="code text-orange">scroll()</span> methods will always use the first level cache. Actually, there is nothing more to add.</p>
<h2>Second level caching</h2>
<p>If the first level cache is bound to the session object, then the second level cache is bound to the session object.<mark class="green">SessionFactory</mark>. Which means that the visibility of objects in this cache is much wider than in the first level cache.</p>
<p>Example:</p>
<pre class=" line-numbers language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><code class=" language-java"><span class="token class-name">Session</span> session <span class="token operator">=</span> factory<span class="token punctuation">.</span><span class="token function">openSession</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">Employee</span> director1 <span class="token operator">=</span> session<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token class-name">Employee</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
session<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token class-name">Session</span> session <span class="token operator">=</span> factory<span class="token punctuation">.</span><span class="token function">openSession</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">Employee</span> director2 <span class="token operator">=</span> session<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token class-name">Employee</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
session<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">assertTrue</span><span class="token punctuation">(</span>director1 <span class="token operator">!=</span> director2<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">assertTrue</span><span class="token punctuation">(</span>director1<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>director2<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p>In this example, two queries will be made to the database. Hibernate will return identical objects, but it won't be the same object - they will have different references.</p>
<p><strong><span class="text-red">Second level caching is disabled</span></strong><strong> by default</strong> . Therefore, we have two queries to the database instead of one.</p>
<p>To enable it, you need to write the following lines in the hibernate.cfg.xml file:</p>
<pre class=" line-numbers language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span><code class=" language-java"><span class="token operator">&lt;</span>property name<span class="token operator">=</span><span class="token string">"hibernate.cache.provider_class"</span> value<span class="token operator">=</span><span class="token string">"net.sf.ehcache.hibernate.SingletEhCacheProvider"</span><span class="token operator">/</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>property name<span class="token operator">=</span><span class="token string">"hibernate.cache.use_second_level_cache"</span> value<span class="token operator">=</span><span class="token string">"true"</span><span class="token operator">/</span><span class="token operator">&gt;</span></code></pre>
<p>After enabling second-level caching, Hibernate behavior will change a bit:</p>
<pre class=" line-numbers language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><code class=" language-java"><span class="token class-name">Session</span> session <span class="token operator">=</span> factory<span class="token punctuation">.</span><span class="token function">openSession</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">Employee</span> director1 <span class="token operator">=</span> session<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token class-name">Employee</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
session<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token class-name">Session</span> session <span class="token operator">=</span> factory<span class="token punctuation">.</span><span class="token function">openSession</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">Employee</span> director2 <span class="token operator">=</span> session<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token class-name">Employee</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
session<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">assertTrue</span><span class="token punctuation">(</span>director1 <span class="token operator">==</span> director2<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p>Only after all these manipulations will the second-level cache be enabled, and in the example above, only one query to the database will be executed.</p>
