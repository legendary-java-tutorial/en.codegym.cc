Criteria API Part 2
<p>----------------------------------------</p>
Grouping and aggregation functions. CriteriaUpdate. CriteriaDelete. Benefit from the Criteria API.
<p>----------------------------------------</p>
p>You have already figured out how to make simple requests to the Criteria API. Let's see how to make more complex queries.</p>
<p>For example, we want to write a query to determine the number of employees in a company. Here is how it will look like in HQL:</p>
<pre><code><strong><span class="text-red">select count</span>(*) <span class="text-red">from</span> <span class="text-orange">Employee</span></strong></code></pre>
<p>And like this on the Criteria API:</p>
<pre class=" line-numbers language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span><code class=" language-java"><span class="token class-name">CriteriaQuery</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> critQuery <span class="token operator">=</span> builder<span class="token punctuation">.</span><span class="token function">createQuery</span><span class="token punctuation">(</span><span class="token class-name">Long</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
critQuery<span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span>builder<span class="token punctuation">.</span><span class="token function">count</span><span class="token punctuation">(</span>critQuery<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token class-name">Employee</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p>The complete Java code will look like this:</p>
<pre class=" line-numbers language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><code class=" language-java"><span class="token class-name">CriteriaBuilder</span> builder <span class="token operator">=</span> session<span class="token punctuation">.</span><span class="token function">getCriteriaBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token class-name">CriteriaQuery</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> critQuery <span class="token operator">=</span> builder<span class="token punctuation">.</span><span class="token function">createQuery</span><span class="token punctuation">(</span><span class="token class-name">Long</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
critQuery<span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span>builder<span class="token punctuation">.</span><span class="token function">count</span><span class="token punctuation">(</span>critQuery<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token class-name">Employee</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token class-name">Query</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> query <span class="token operator">=</span> session<span class="token punctuation">.</span><span class="token function">createQuery</span><span class="token punctuation">(</span>critQuery<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">Long</span> count <span class="token operator">=</span> query<span class="token punctuation">.</span><span class="token function">getSingleResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p>And it's the same using HQL:</p>
<pre class=" line-numbers language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span><code class=" language-java"><span class="token class-name">String</span> hqlQuery <span class="token operator">=</span> <span class="token string">"select count(*) from Employee"</span><span class="token punctuation">;</span>

<span class="token class-name">Query</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> query <span class="token operator">=</span> session<span class="token punctuation">.</span><span class="token function">createQuery</span><span class="token punctuation">(</span>hqlQuery<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">Long</span> count <span class="token operator">=</span> query<span class="token punctuation">.</span><span class="token function">getSingleResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p>Now let's try to calculate the average salary in the company. The HQL query will look like this:</p>
<pre><code><strong><span class="text-red">select avg</span>(<span class="text-green">salary</span>) <span class="text-red">from</span> <span class="text-orange">Employee</span></strong></code></pre>
<p>And like this on the Criteria API:</p>
<pre class=" line-numbers language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span><code class=" language-java"><span class="token class-name">CriteriaQuery</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Double</span><span class="token punctuation">&gt;</span></span> critQuery <span class="token operator">=</span> builder<span class="token punctuation">.</span><span class="token function">createQuery</span><span class="token punctuation">(</span><span class="token class-name">Double</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
critQuery<span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span>builder<span class="token punctuation">.</span><span class="token function">avg</span><span class="token punctuation">(</span> critQuery<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token class-name">Employee</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"salary"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p>The complete Java code will look like this:</p>
<pre class=" line-numbers language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><code class=" language-java"><span class="token class-name">CriteriaBuilder</span> builder <span class="token operator">=</span> session<span class="token punctuation">.</span><span class="token function">getCriteriaBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token class-name">CriteriaQuery</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Double</span><span class="token punctuation">&gt;</span></span> critQuery <span class="token operator">=</span> builder<span class="token punctuation">.</span><span class="token function">createQuery</span><span class="token punctuation">(</span><span class="token class-name">Double</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
critQuery<span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span>builder<span class="token punctuation">.</span><span class="token function">avg</span><span class="token punctuation">(</span> critQuery<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token class-name">Employee</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"salary"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token class-name">Query</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Double</span><span class="token punctuation">&gt;</span></span> query <span class="token operator">=</span> session<span class="token punctuation">.</span><span class="token function">createQuery</span><span class="token punctuation">(</span>critQuery<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">Double</span> avgSalary <span class="token operator">=</span> query<span class="token punctuation">.</span><span class="token function">getSingleResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<h2>CriteriaUpdate</h2>
<p>Modifying a table is as easy as getting data from it. To do this, CriteriaBuilder has a special method - <span class="code text-orange">createCriteriaUpdate()</span> , which creates an object<mark class="green">CriteriaUpdate&lt;T&gt;</mark>The that updates the entities in the database.</p>
<p>Let's raise the salary of employees who receive less than 10 thousand. Here's what this HQL query would look like:</p>
<pre><code><strong><span class="text-red">update</span> <span class="text-orange">Employee</span> <span class="text-red">set</span> <span class="text-green">salary</span> = <span class="text-green">salary</span>+<span class="text-user">20000</span> <span class="text-red">where</span> <span class="text-green">salary</span>&lt;=<span class="text-neon">10000</span></strong></code></pre>
<p>And this is how it will look on the Criteria API:</p>
<pre class=" line-numbers language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><code class=" language-java"><span class="token class-name">CriteriaUpdate</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Employee</span><span class="token punctuation">&gt;</span></span> criteriaUpdate <span class="token operator">=</span> builder<span class="token punctuation">.</span><span class="token function">createCriteriaUpdate</span><span class="token punctuation">(</span><span class="token class-name">Employee</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">Root</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Employee</span><span class="token punctuation">&gt;</span></span> root <span class="token operator">=</span> criteriaUpdate<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token class-name">Employee</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
criteriaUpdate<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">"salary"</span><span class="token punctuation">,</span> <span class="token string">"salary+20000"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
criteriaUpdate<span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span>builder<span class="token punctuation">.</span><span class="token function">lt</span><span class="token punctuation">(</span>root<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"salary"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">10000</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token class-name">Transaction</span> transaction <span class="token operator">=</span> session<span class="token punctuation">.</span><span class="token function">beginTransaction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
session<span class="token punctuation">.</span><span class="token function">createQuery</span><span class="token punctuation">(</span>criteriaUpdate<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">executeUpdate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
transaction<span class="token punctuation">.</span><span class="token function">commit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<h2>CriteriaDelete</h2>
<p>And deleting records is even easier than changing them. To do this, there is a special method <span class="code text-orange">createCriteriaDelete()</span> , which creates an object<mark class="green">CriteriaDelete&lt;T&gt;</mark>.</p>
<p>Let's cut all employees who have no value: their salary is less than 10 thousand. Here's what this HQL query would look like:</p>
<pre><code><strong><span class="text-red">delete from</span> <span class="text-orange">Employee</span> <span class="text-red">where</span> <span class="text-green">salary</span>&lt;=<span class="text-neon">10000</span></strong></code></pre>
<p>And this is how it will look on the Criteria API:</p>
<pre class=" line-numbers language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><code class=" language-java"><span class="token class-name">CriteriaDelete</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Employee</span><span class="token punctuation">&gt;</span></span> criteriaDelete <span class="token operator">=</span> builder<span class="token punctuation">.</span><span class="token function">createCriteriaDelete</span><span class="token punctuation">(</span><span class="token class-name">Employee</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">Root</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Employee</span><span class="token punctuation">&gt;</span></span> root <span class="token operator">=</span> criteriaDelete<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token class-name">Employee</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
criteriaDelete<span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span>builder<span class="token punctuation">.</span><span class="token function">lt</span><span class="token punctuation">(</span>root<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"salary"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">10000</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token class-name">Transaction</span> transaction <span class="token operator">=</span> session<span class="token punctuation">.</span><span class="token function">beginTransaction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
session<span class="token punctuation">.</span><span class="token function">createQuery</span><span class="token punctuation">(</span>criteriaDelete<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">executeUpdate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
transaction<span class="token punctuation">.</span><span class="token function">commit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<h2>Benefits of the Criteria API</h2>
<p>So what is the benefit of the Criteria API? Queries are cumbersome, HQL will definitely be more compact.</p>
<p>Firstly, HQL queries are not so short if you need to pass parameters to them. Compare:</p>
<div class="table-container">
 <table>
  <tbody>
   <tr>
    <th><strong>We consider the number of employees with a salary of less than 10 thousand</strong></th>
   </tr>
   <tr>
    <th>HQL</th>
   </tr>
   <tr>
    <td>
     <pre><code><strong>String <span class="text-red">hqlQuery</span> = <span class="text-green">"from Employee where salary &lt; :sal"</span>;
Query&lt;<span class="text-orange">Employee</span>&gt; <span class="text-viola">query</span> = <span class="text-user">session</span>.createQuery(<span class="text-red">hqlQuery</span>);
<span class="text-viola">query</span>.setParametr(<span class="text-green">"sal"</span>, <span class="text-neon">10000</span>);
List&lt;<span class="text-orange">Employee</span>&gt; results = <span class="text-viola">query</span>.getResultList();</strong></code></pre></td>
   </tr>
   <tr>
    <th>Criteria API</th>
   </tr>
   <tr>
    <td>
     <pre class=" language-java" tabindex="0"><code class=" language-java"><span class="token class-name">CriteriaBuilder</span> builder <span class="token operator">=</span> session<span class="token punctuation">.</span><span class="token function">getCriteriaBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
critQuery<span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span>critQuery<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token class-name">Employee</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span>builder<span class="token punctuation">.</span><span class="token function">lt</span><span class="token punctuation">(</span>root<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"salary"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">10000</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">Query</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Employee</span><span class="token punctuation">&gt;</span></span> query <span class="token operator">=</span> session<span class="token punctuation">.</span><span class="token function">createQuery</span><span class="token punctuation">(</span>critQuery<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Employee</span><span class="token punctuation">&gt;</span></span> results <span class="token operator">=</span> query<span class="token punctuation">.</span><span class="token function">getResultList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></td>
   </tr>
  </tbody>
 </table>
</div>
<p>Secondly, very often there is a situation when a query needs to be constructed dynamically. For example, you have a web page filtering employees, apartments, and anything. And if some parameter is not important to the user, then he simply does not indicate it. Accordingly, null is passed to the server instead.</p>
<p>Here is your task: to select employees with a certain profession (occupation), salary (salary) and year of employment (YEAR (join_date)). But if any parameter value is null, then don't use it in the filter.</p>
<p>Then the HQL query will look something like this:</p>
<pre class=" line-numbers language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span><code class=" language-java">from <span class="token class-name">Employee</span>
where <span class="token punctuation">(</span>occupation <span class="token operator">=</span> <span class="token operator">:</span>ocp<span class="token punctuation">)</span>
   	and <span class="token punctuation">(</span>salary <span class="token operator">=</span> <span class="token operator">:</span>sal<span class="token punctuation">)</span>
   	and <span class="token punctuation">(</span> <span class="token function">YEAR</span><span class="token punctuation">(</span>join_date<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token operator">:</span>jny<span class="token punctuation">)</span></code></pre>
<p>But it will not work correctly, since we want that if the "jny" parameter was null, then the request would look like this:</p>
<pre class=" line-numbers language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span><code class=" language-java">from <span class="token class-name">Employee</span>
where <span class="token punctuation">(</span>occupation <span class="token operator">=</span> <span class="token operator">:</span>ocp<span class="token punctuation">)</span>
   	and <span class="token punctuation">(</span>salary <span class="token operator">=</span> <span class="token operator">:</span>sal<span class="token punctuation">)</span></code></pre>
<p>We can try to rewrite the request with checking the parameter for null, then we will get something like this:</p>
<pre class=" line-numbers language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span><code class=" language-java">from <span class="token class-name">Employee</span>
where <span class="token punctuation">(</span>occupation <span class="token operator">=</span> <span class="token operator">:</span>ocp or <span class="token operator">:</span>ocp is <span class="token keyword">null</span><span class="token punctuation">)</span>
   	and <span class="token punctuation">(</span>salary <span class="token operator">=</span> <span class="token operator">:</span>sal or <span class="token operator">:</span>sal is <span class="token keyword">null</span><span class="token punctuation">)</span>
   	and <span class="token punctuation">(</span> <span class="token function">YEAR</span><span class="token punctuation">(</span>join_date<span class="token punctuation">)</span><span class="token operator">=</span> <span class="token operator">:</span>jny or <span class="token operator">:</span>jny is <span class="token keyword">null</span><span class="token punctuation">)</span></code></pre>
<p>See how reality gets more complicated? Reality is often like this :)</p>
<p>But the filter can be complicated even more. How about searching for users who have tasks with the word "buy" in them? Or users who have overdue tasks?</p>
<pre class=" line-numbers language-java" tabindex="0"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span><code class=" language-java">from <span class="token class-name">Employee</span>
where <span class="token punctuation">(</span>occupation <span class="token operator">=</span> <span class="token operator">:</span>ocp<span class="token punctuation">)</span>
   	and <span class="token punctuation">(</span>salary <span class="token operator">=</span> <span class="token operator">:</span>sal<span class="token punctuation">)</span>
   	and <span class="token punctuation">(</span><span class="token function">YEAR</span><span class="token punctuation">(</span>join_date<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token operator">:</span>jny<span class="token punctuation">)</span>
   	and <span class="token punctuation">(</span>tasks<span class="token punctuation">.</span>name like <span class="token string">'%buy%'</span><span class="token punctuation">)</span>
   	and <span class="token punctuation">(</span>tasks<span class="token punctuation">.</span>deadline <span class="token operator">&lt;</span> <span class="token function">curdate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></code></pre>
<p><strong>If you write or is null</strong> somewhere in such a query , then this will not cancel the join between tables.</p>
<p>So in practice, when you do any complex filter on the fields of several tables, the Criteria API can just help you out. So it goes.</p>
<p>More details can be found in <a href="https://docs.jboss.org/hibernate/orm/6.0/userguide/html_single/Hibernate_User_Guide.html#criteria-typedquery" target="_blank" rel="nofollow">the official documentation</a> .</p>